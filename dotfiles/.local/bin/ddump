#!/bin/bash -e

if [ -z "$1" ]; then
  echo "Usage: ddump <domain> [dir]"
  exit 1
fi

dir="${2:-"$PWD"}"
mkdir -p "$dir" "$dir/subdomains"

dump () {
  dump="$(dnsdump "$1" 2>/dev/null)"

  if [[ "$dump" =~ ":" ]]; then
    echo "$1" >> "$dir/subdomains.dump"
    echo "$dump" > "$dir/subdomains/$1.dump"
  fi
}

amass enum -passive -d "$1" 2> /dev/null | while read -r subdomain; do
  dump "$subdomain" &
done

wait

subdomains="$(sort -u "$dir/subdomains.dump")"
echo "$subdomains" > "$dir/subdomains.dump"

grep -E '([0-9]{1,3}\.){3}[0-9]{1,3}' -hoR "$dir/subdomains" | sort -u > "$dir/ips.dump"
