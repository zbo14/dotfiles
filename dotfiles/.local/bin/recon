#!/bin/bash

if [ -z "$1" ]; then
  warn "Usage: recon <program> [dir]"
  exit 1
fi

if [ ! -z "$2" ]; then
  cd "$2"
fi

warn "[-] Running endpoint and URL discovery with sourcery"

mkdir -p out
sourcery -d "$(paste -s -d, domains.txt)" -o out urls.txt

sortfile out/paths.txt
sortfile out/subdomains.txt
sortfile out/urls.txt

cat out/subdomains.txt >> subdomains.txt

sortfile subdomains.txt

warn "[-] Running passive subdomain enumeration with sc0pe"

sc0pe -a burp-config.json >> subdomains.txt

warn "[-] Running active enumeration with amass and tracking changes"

amass enum -active -df domains.txt >> subdomains.txt
amass track -last 1 -df domains.txt > changes.txt

sortfile subdomains.txt

warn "[-] Resolving subdomains"

resolve subdomains.txt | sort -u > resolved.txt

grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' resolved.txt | sort -u | privaddr > private-ips.txt 2> resolved-ips.txt
uptil , resolved.txt | sort -u > resolved-subdomains.txt

comm -23 subdomains.txt resolved-subdomains.txt > unresolved.txt

warn "[-] Checking alive subdomains and IP addresses"

cat resolved-ips.txt | httprobe | sort -u > ip-urls.txt
cat resolved-subdomains.txt | httprobe | sort -u > subdomain-urls.txt

cat ip-urls.txt | urlhost | sort -u > alive-ips.txt
cat subdomain-urls.txt | urlhost | sort -u > alive-subdomains.txt

warn "[-] Writing subdomains, IP addresses, and URLs to database"

mongomap push "$1" domains alive-subdomains.txt
mongomap push "$1" ips alive-ips.txt
mongomap push "$1" urls ip-urls
mongomap push "$1" urls subdomain-urls

warn "[-] Pulling new subdomains, IP addresses, and URLs from database"

mongomap pull "$1" domains > new-subdomains.txt
mongomap pull "$1" ips > new-ips.txt
mongomap pull "$1" urls > new-urls.txt

warn "[-] Filtering endpoints by status code"

~/Projects/responsieve/responsieve -k -s 401,403 subdomain-urls.txt | urlhost | sort -u > off-limits.txt

warn "[-] Taking screenshots"

mkdir -p screenshots
cat new-urls.txt | aquatone -out screenshots

warn "[-] Scanning ports"

ports="$(sudo nmap -n -Pn -p- -sS -T4 -iL new-ips.txt)"
echo "$ports" > ports.txt
